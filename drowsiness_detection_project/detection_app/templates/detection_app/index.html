<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Drowsiness Detection System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-4xl font-bold mb-8 text-indigo-700 text-center">Advanced Drowsiness Detection System</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600">Live Feed</h2>
                <img class="w-full h-auto border rounded-lg" src="{% url 'video_feed' %}" alt="Video Feed">
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600">Detection Controls</h2>
                <label class="inline-flex items-center mb-4">
                    <input type="checkbox" id="detectionToggle" class="form-checkbox h-5 w-5 text-indigo-600" onchange="toggleDetection()">
                    <span class="ml-2 text-xl font-medium text-gray-700">Enable Drowsiness Detection</span>
                </label>
                <div id="status" class="text-lg font-semibold text-indigo-600 mb-4">Detection is OFF</div>
                <div id="alertLevel" class="text-lg font-semibold text-green-600">Alert Level: Normal</div>
                <div class="mt-4">
                    <canvas id="alertChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600">Current Location</h2>
                <div id="location" class="text-lg text-gray-700">Fetching your current location...</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-600">Nearby Rest Areas</h2>
                <div id="nearbyPlaces" class="text-lg text-gray-700">Nearby places to rest: None yet</div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600">Map</h2>
            <div id="map" class="w-full h-96 bg-gray-200 rounded-lg"></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-indigo-600">Drowsiness Statistics</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-4 bg-indigo-100 rounded-lg">
                    <h3 class="text-lg font-semibold text-indigo-700">Total Drive Time</h3>
                    <p id="totalDriveTime" class="text-2xl font-bold text-indigo-800">00:00:00</p>
                </div>
                <div class="p-4 bg-yellow-100 rounded-lg">
                    <h3 class="text-lg font-semibold text-yellow-700">Drowsy Episodes</h3>
                    <p id="drowsyEpisodes" class="text-2xl font-bold text-yellow-800">0</p>
                </div>
                <div class="p-4 bg-green-100 rounded-lg">
                    <h3 class="text-lg font-semibold text-green-700">Average Alertness</h3>
                    <p id="avgAlertness" class="text-2xl font-bold text-green-800">100%</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let detectionActive = false;
        let mapInitialized = false;
        let alertChart;
        let startTime;
        let drowsyCount = 0;
        let totalAlertness = 100;
        let alertnessReadings = 0;
        mapboxgl.accessToken = 'your_mapbox_access_token'; // Replace with your Mapbox token

        function toggleDetection() {
            detectionActive = !detectionActive;
            const statusText = detectionActive ? "Detection is ON" : "Detection is OFF";
            document.getElementById('status').innerText = statusText;

            if (detectionActive) {
                startTime = new Date();
                updateDriveTime();
            }

            fetch('/toggle_detection/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                },
                body: JSON.stringify({ active: detectionActive })
            });

            if (!mapInitialized && detectionActive) {
                initializeMap();
                mapInitialized = true;
            }
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function showPosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            document.getElementById('location').innerText = `Latitude: ${lat.toFixed(4)}, Longitude: ${lon.toFixed(4)}`;

            if (detectionActive) {
                fetch(`/nearby_places/?lat=${lat}&lon=${lon}`)
                    .then(response => response.json())
                    .then(data => {
                        const places = data.places.join(", ");
                        document.getElementById('nearbyPlaces').innerText = `Nearby places to rest: ${places}`;
                        addMarkersToMap(lat, lon, data.places);
                    });
            }
        }

        function initializeMap() {
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [78.9629, 20.5937],
                zoom: 5
            });

            map.addControl(new mapboxgl.NavigationControl());
        }

        function addMarkersToMap(lat, lon, places) {
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [lon, lat],
                zoom: 12
            });

            // Add user's location marker
            new mapboxgl.Marker({ color: "#FF0000" })
                .setLngLat([lon, lat])
                .addTo(map);

            places.forEach((place, index) => {
                // Add markers at the nearby rest area coordinates (dummy for now)
                new mapboxgl.Marker({ color: "#00FF00" })
                    .setLngLat([lon + (index * 0.01), lat + (index * 0.01)])
                    .setPopup(new mapboxgl.Popup().setHTML(`<h3>${place}</h3>`))
                    .addTo(map);
            });

            map.addControl(new mapboxgl.NavigationControl());
        }

        function initAlertChart() {
            const ctx = document.getElementById('alertChart').getContext('2d');
            alertChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Alertness Level',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function updateAlertLevel() {
            if (detectionActive) {
                const alertLevel = Math.floor(Math.random() * 100);
                const alertDiv = document.getElementById('alertLevel');
                alertDiv.innerText = `Alert Level: ${alertLevel}%`;
                
                if (alertLevel < 30) {
                    alertDiv.className = 'text-lg font-semibold text-red-600';
                    drowsyCount++;
                } else if (alertLevel < 70) {
                    alertDiv.className = 'text-lg font-semibold text-yellow-600';
                } else {
                    alertDiv.className = 'text-lg font-semibold text-green-600';
                }

                updateChart(alertLevel);
                updateStatistics(alertLevel);
            }
        }

        function updateChart(alertLevel) {
            const now = new Date();
            alertChart.data.labels.push(now.toLocaleTimeString());
            alertChart.data.datasets[0].data.push(alertLevel);

            if (alertChart.data.labels.length > 10) {
                alertChart.data.labels.shift();
                alertChart.data.datasets[0].data.shift();
            }

            alertChart.update();
        }

        function updateDriveTime() {
            if (detectionActive) {
                const now = new Date();
                const diff = now - startTime;
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                document.getElementById('totalDriveTime').innerText = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                setTimeout(updateDriveTime, 1000);
            }
        }

        function updateStatistics(alertLevel) {
            document.getElementById('drowsyEpisodes').innerText = drowsyCount;
            
            totalAlertness += alertLevel;
            alertnessReadings++;
            const avgAlertness = Math.round(totalAlertness / alertnessReadings);
            document.getElementById('avgAlertness').innerText = `${avgAlertness}%`;
        }

        window.onload = function() {
            getLocation();
            initAlertChart();
            setInterval(updateAlertLevel, 5000); // Update alert level every 5 seconds
        };
    </script>
</body>
</html>